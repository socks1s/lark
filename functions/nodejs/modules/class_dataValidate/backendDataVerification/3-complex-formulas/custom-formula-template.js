/**
 * è‡ªå®šä¹‰å…¬å¼å‡½æ•°æ¨¡æ¿
 * æä¾›æ ‡å‡†çš„å‡½æ•°ç¼–å†™æ ¼å¼å’Œæœ€ä½³å®è·µ
 */

// ğŸ¯ è‡ªå®šä¹‰å…¬å¼å‡½æ•°æ ‡å‡†æ ¼å¼
const customFormulaTemplate = {
  
  // ===== å­è¡¨å­—æ®µå…¬å¼æ¨¡æ¿ =====
  "child.å­—æ®µå": {
    // ğŸ“‹ å¿…å¡«ï¼šå£°æ˜ä¾èµ–å­—æ®µï¼ˆç”¨äºè‡ªåŠ¨æ’åºï¼‰
    dependencies: ["child.ä¾èµ–å­—æ®µ1", "child.ä¾èµ–å­—æ®µ2", "main.ä¸»è¡¨ä¾èµ–å­—æ®µ"],
    
    // ğŸ”§ å¿…å¡«ï¼šè®¡ç®—å‡½æ•°
    calculate: (data, child) => {
      // è·å–å½“å‰å­è®°å½•çš„å­—æ®µå€¼
      const å­—æ®µ1 = child.ä¾èµ–å­—æ®µ1;
      const å­—æ®µ2 = child.ä¾èµ–å­—æ®µ2;
      
      // è·å–ä¸»è¡¨å­—æ®µå€¼
      const ä¸»è¡¨å­—æ®µ = data.mainRecord.ä¸»è¡¨ä¾èµ–å­—æ®µ;
      
      // å¤æ‚ä¸šåŠ¡é€»è¾‘ç¤ºä¾‹
      let result = 0;
      
      // æ¡ä»¶åˆ¤æ–­
      if (å­—æ®µ1 > 100) {
        result = å­—æ®µ1 * å­—æ®µ2 * 1.1; // åŠ ä»·10%
      } else {
        result = å­—æ®µ1 * å­—æ®µ2;
      }
      
      // åŸºäºä¸»è¡¨å­—æ®µçš„è°ƒæ•´
      if (ä¸»è¡¨å­—æ®µ === "VIP") {
        result *= 0.9; // VIPæŠ˜æ‰£
      }
      
      // å¤šé‡æ¡ä»¶åˆ¤æ–­
      switch (child.ç±»åˆ«) {
        case "Aç±»":
          result *= 1.2;
          break;
        case "Bç±»":
          result *= 1.1;
          break;
        default:
          result *= 1.0;
      }
      
      // æ•°å€¼å¤„ç†
      return Math.round(result * 100) / 100; // ä¿ç•™2ä½å°æ•°
    }
  },

  // ===== ä¸»è¡¨å­—æ®µå…¬å¼æ¨¡æ¿ =====
  "main.å­—æ®µå": {
    // ğŸ“‹ å£°æ˜ä¾èµ–ï¼ˆå¯ä»¥ä¾èµ–å­è¡¨å­—æ®µï¼‰
    dependencies: ["child.å­è¡¨å­—æ®µ", "main.å…¶ä»–ä¸»è¡¨å­—æ®µ"],
    
    // ğŸ”§ è®¡ç®—å‡½æ•°ï¼ˆåªæ¥æ”¶dataå‚æ•°ï¼‰
    calculate: (data) => {
      // è·å–ä¸»è¡¨å­—æ®µ
      const ä¸»è¡¨å­—æ®µ = data.mainRecord.å…¶ä»–ä¸»è¡¨å­—æ®µ;
      
      // èšåˆå­è¡¨æ•°æ®
      const å­è¡¨æ€»å’Œ = data.childRecords.reduce((sum, child) => {
        return sum + (child.å­è¡¨å­—æ®µ || 0);
      }, 0);
      
      // å¤æ‚èšåˆé€»è¾‘
      const åŠ æƒå¹³å‡ = data.childRecords.reduce((total, child, index, array) => {
        const æƒé‡ = child.æ•°é‡ / array.reduce((sum, c) => sum + c.æ•°é‡, 0);
        return total + (child.å­è¡¨å­—æ®µ * æƒé‡);
      }, 0);
      
      // æ¡ä»¶èšåˆ
      const Aç±»å•†å“æ€»ä»· = data.childRecords
        .filter(child => child.ç±»åˆ« === "Aç±»")
        .reduce((sum, child) => sum + child.å­è¡¨å­—æ®µ, 0);
      
      // å¤æ‚ä¸šåŠ¡è§„åˆ™
      let result = å­è¡¨æ€»å’Œ;
      
      if (Aç±»å•†å“æ€»ä»· > 1000) {
        result *= 0.95; // å¤§é¢Aç±»å•†å“æŠ˜æ‰£
      }
      
      if (data.childRecords.length > 5) {
        result *= 0.98; // å¤šå“ç§æŠ˜æ‰£
      }
      
      // æœ€å€¼é™åˆ¶
      const æœ€å°å€¼ = å­è¡¨æ€»å’Œ * 0.8;
      const æœ€å¤§å€¼ = å­è¡¨æ€»å’Œ * 1.2;
      result = Math.max(æœ€å°å€¼, Math.min(result, æœ€å¤§å€¼));
      
      return Math.round(result);
    }
  }
};

// ğŸ”§ é«˜çº§å…¬å¼å‡½æ•°ç¤ºä¾‹
const advancedFormulaExamples = {
  
  // åŠ¨æ€æŠ˜æ‰£ç‡è®¡ç®—
  "main.åŠ¨æ€æŠ˜æ‰£ç‡": {
    dependencies: ["main.åŸºç¡€æ€»ä»·", "main.å®¢æˆ·ç­‰çº§", "main.å†å²é‡‡è´­é¢"],
    calculate: (data) => {
      const { åŸºç¡€æ€»ä»·, å®¢æˆ·ç­‰çº§, å†å²é‡‡è´­é¢ } = data.mainRecord;
      
      // åŸºç¡€æŠ˜æ‰£
      const ç­‰çº§æŠ˜æ‰£ = {
        "é’»çŸ³": 0.15,
        "é‡‘ç‰Œ": 0.10,
        "é“¶ç‰Œ": 0.05,
        "æ™®é€š": 0.00
      }[å®¢æˆ·ç­‰çº§] || 0;
      
      // é‡‘é¢é˜¶æ¢¯æŠ˜æ‰£
      let é‡‘é¢æŠ˜æ‰£ = 0;
      if (åŸºç¡€æ€»ä»· > 5000) é‡‘é¢æŠ˜æ‰£ = 0.08;
      else if (åŸºç¡€æ€»ä»· > 2000) é‡‘é¢æŠ˜æ‰£ = 0.05;
      else if (åŸºç¡€æ€»ä»· > 1000) é‡‘é¢æŠ˜æ‰£ = 0.02;
      
      // å†å²é‡‡è´­å¥–åŠ±
      const å†å²å¥–åŠ± = å†å²é‡‡è´­é¢ > 50000 ? 0.03 : 
                     å†å²é‡‡è´­é¢ > 20000 ? 0.02 : 
                     å†å²é‡‡è´­é¢ > 10000 ? 0.01 : 0;
      
      // ç»„åˆæŠ˜æ‰£ï¼ˆæœ‰ä¸Šé™ï¼‰
      return Math.min(ç­‰çº§æŠ˜æ‰£ + é‡‘é¢æŠ˜æ‰£ + å†å²å¥–åŠ±, 0.25);
    }
  },

  // åº“å­˜é¢„è­¦ç³»æ•°
  "child.åº“å­˜é¢„è­¦ç³»æ•°": {
    dependencies: ["child.åº“å­˜", "child.æ•°é‡", "child.å®‰å…¨åº“å­˜"],
    calculate: (data, child) => {
      const { åº“å­˜, æ•°é‡, å®‰å…¨åº“å­˜ } = child;
      const å‰©ä½™åº“å­˜ = åº“å­˜ - æ•°é‡;
      
      if (å‰©ä½™åº“å­˜ < 0) {
        return 3.0; // ç¼ºè´§é£é™©
      } else if (å‰©ä½™åº“å­˜ < å®‰å…¨åº“å­˜) {
        return 2.0; // ä½åº“å­˜é£é™©
      } else if (å‰©ä½™åº“å­˜ < å®‰å…¨åº“å­˜ * 2) {
        return 1.5; // ä¸­ç­‰é£é™©
      } else {
        return 1.0; // å®‰å…¨åº“å­˜
      }
    }
  },

  // å­£èŠ‚æ€§ä»·æ ¼è°ƒæ•´
  "child.å­£èŠ‚è°ƒæ•´ä»·æ ¼": {
    dependencies: ["child.åŸºç¡€ä»·æ ¼", "child.å•†å“ç±»åˆ«"],
    calculate: (data, child) => {
      const { åŸºç¡€ä»·æ ¼, å•†å“ç±»åˆ« } = child;
      const å½“å‰æœˆä»½ = new Date().getMonth() + 1;
      
      // å­£èŠ‚æ€§ç³»æ•°é…ç½®
      const å­£èŠ‚ç³»æ•°è¡¨ = {
        "æœè£…": {
          æ˜¥å­£: [3, 4, 5],
          å¤å­£: [6, 7, 8], 
          ç§‹å­£: [9, 10, 11],
          å†¬å­£: [12, 1, 2]
        },
        "ç”µå­äº§å“": {
          ä¿ƒé”€å­£: [6, 11, 12], // 618ã€åŒ11ã€åŒ12
          å¹³å­£: [1, 2, 3, 4, 5, 7, 8, 9, 10]
        }
      };
      
      let è°ƒæ•´ç³»æ•° = 1.0;
      
      if (å•†å“ç±»åˆ« === "æœè£…") {
        if ([6, 7, 8].includes(å½“å‰æœˆä»½)) {
          è°ƒæ•´ç³»æ•° = 0.8; // å¤å­£æœè£…æ‰“æŠ˜
        } else if ([12, 1, 2].includes(å½“å‰æœˆä»½)) {
          è°ƒæ•´ç³»æ•° = 1.2; // å†¬å­£æœè£…æ¶¨ä»·
        }
      } else if (å•†å“ç±»åˆ« === "ç”µå­äº§å“") {
        if ([6, 11, 12].includes(å½“å‰æœˆä»½)) {
          è°ƒæ•´ç³»æ•° = 0.9; // ä¿ƒé”€å­£æŠ˜æ‰£
        }
      }
      
      return Math.round(åŸºç¡€ä»·æ ¼ * è°ƒæ•´ç³»æ•° * 100) / 100;
    }
  }
};

// ğŸ“š ç¼–å†™è‡ªå®šä¹‰å…¬å¼çš„æœ€ä½³å®è·µ
const bestPractices = {
  "ä¾èµ–å£°æ˜": {
    "åŸåˆ™": "å‡†ç¡®å£°æ˜æ‰€æœ‰ä¾èµ–å­—æ®µï¼Œç¡®ä¿è®¡ç®—é¡ºåºæ­£ç¡®",
    "ç¤ºä¾‹": `dependencies: ["child.å•ä»·", "child.æ•°é‡", "main.æŠ˜æ‰£ç‡"]`,
    "æ³¨æ„": "ä¸è¦é—æ¼ä¾èµ–ï¼Œå¦åˆ™å¯èƒ½å¯¼è‡´è®¡ç®—é”™è¯¯"
  },
  
  "é”™è¯¯å¤„ç†": {
    "åŸåˆ™": "å¯¹å¯èƒ½çš„ç©ºå€¼ã€undefinedè¿›è¡Œé˜²æŠ¤",
    "ç¤ºä¾‹": `const æ•°é‡ = child.æ•°é‡ || 0; // é»˜è®¤å€¼å¤„ç†`,
    "å»ºè®®": "ä½¿ç”¨ || 0 æˆ– ?? 0 æä¾›é»˜è®¤å€¼"
  },
  
  "æ•°å€¼ç²¾åº¦": {
    "åŸåˆ™": "é‡‘é¢è®¡ç®—è¦æ³¨æ„ç²¾åº¦é—®é¢˜",
    "ç¤ºä¾‹": `return Math.round(result * 100) / 100; // ä¿ç•™2ä½å°æ•°`,
    "å»ºè®®": "ç»Ÿä¸€ä½¿ç”¨ç›¸åŒçš„ç²¾åº¦å¤„ç†æ–¹å¼"
  },
  
  "æ€§èƒ½ä¼˜åŒ–": {
    "åŸåˆ™": "é¿å…åœ¨å¾ªç¯ä¸­è¿›è¡Œé‡å¤è®¡ç®—",
    "ç¤ºä¾‹": `const æ€»æ•°é‡ = data.childRecords.reduce((sum, c) => sum + c.æ•°é‡, 0); // æå‰è®¡ç®—`,
    "å»ºè®®": "å°†å…¬å…±è®¡ç®—æå–åˆ°å¾ªç¯å¤–"
  },
  
  "å¯è¯»æ€§": {
    "åŸåˆ™": "ä½¿ç”¨æœ‰æ„ä¹‰çš„å˜é‡åï¼Œæ·»åŠ å¿…è¦æ³¨é‡Š",
    "ç¤ºä¾‹": `const VIPæŠ˜æ‰£ç‡ = 0.1; // é‡‘ç‰Œå®¢æˆ·10%æŠ˜æ‰£`,
    "å»ºè®®": "å¤æ‚é€»è¾‘è¦æœ‰æ¸…æ™°çš„æ³¨é‡Šè¯´æ˜"
  }
};

// ğŸ§ª æµ‹è¯•è‡ªå®šä¹‰å…¬å¼çš„å·¥å…·å‡½æ•°
function testCustomFormula(fieldName, config, testData) {
  console.log(`\nğŸ§ª æµ‹è¯•å…¬å¼: ${fieldName}`);
  console.log(`ä¾èµ–: [${config.dependencies.join(', ')}]`);
  
  try {
    if (fieldName.startsWith('child.')) {
      testData.childRecords.forEach(child => {
        const result = config.calculate(testData, child);
        console.log(`  ${child.id}: ${result}`);
      });
    } else {
      const result = config.calculate(testData);
      console.log(`  ç»“æœ: ${result}`);
    }
    console.log(`âœ… æµ‹è¯•é€šè¿‡`);
  } catch (error) {
    console.log(`âŒ æµ‹è¯•å¤±è´¥: ${error.message}`);
  }
}

console.log("ğŸ“– è‡ªå®šä¹‰å…¬å¼å‡½æ•°ç¼–å†™æŒ‡å—");
console.log("ğŸ¯ æ”¯æŒå¤æ‚é€»è¾‘ã€æ¡ä»¶åˆ¤æ–­ã€èšåˆè®¡ç®—");
console.log("ğŸ”„ ä¿æŒè‡ªåŠ¨ä¾èµ–è§£æå’Œæ’åºåŠŸèƒ½");
console.log("\nğŸ“š æœ€ä½³å®è·µ:");
console.log(JSON.stringify(bestPractices, null, 2));

module.exports = {
  customFormulaTemplate,
  advancedFormulaExamples,
  bestPractices,
  testCustomFormula
};