# æ¨¡å—3ï¼šè®¡ç®—å¼•æ“Žæ¨¡å— (CalculationEngine)

## ðŸ“ æ¨¡å—æ¦‚è¿°

è®¡ç®—å¼•æ“Žæ¨¡å—è´Ÿè´£æ‰§è¡Œå„ç§ä¸šåŠ¡è®¡ç®—é€»è¾‘ï¼ŒåŒ…æ‹¬å­è¡¨çº§åˆ«çš„å°è®¡è®¡ç®—å’Œä¸»è¡¨çº§åˆ«çš„æ±‡æ€»è®¡ç®—ã€‚æ”¯æŒçµæ´»çš„è®¡ç®—è§„åˆ™é…ç½®ï¼Œå¯æ‰©å±•åˆ°ä¸åŒçš„ä¸šåŠ¡åœºæ™¯ã€‚

## ðŸŽ¯ èŒè´£æè¿°

æ‰§è¡Œå„ç§ä¸šåŠ¡è®¡ç®—é€»è¾‘ï¼ŒåŒ…æ‹¬å­è¡¨çº§åˆ«çš„å°è®¡è®¡ç®—å’Œä¸»è¡¨çº§åˆ«çš„æ±‡æ€»è®¡ç®—ã€‚æ”¯æŒçµæ´»çš„è®¡ç®—è§„åˆ™é…ç½®ï¼Œå¯æ‰©å±•åˆ°ä¸åŒçš„ä¸šåŠ¡åœºæ™¯ã€‚

## âš™ï¸ æ ¸å¿ƒåŠŸèƒ½

### æ•°æ®è®¡ç®—
- æ ¹æ®è®¡ç®—è§„åˆ™å¯¹æ¯ä¸ªå­è¡¨è®°å½•æ‰§è¡Œå­—æ®µè®¡ç®—
- é€šè¿‡è‡ªå®šä¹‰çš„jså‡½æ•°ï¼Œæ¥è®¡ç®—å„å­—æ®µçš„å€¼
- å¤„ç†å­—æ®µé—´çš„ä¾èµ–å…³ç³»
- **æ™ºèƒ½æŽ’åºè®¡ç®—é¡ºåº**ï¼šæ ¹æ®å­—æ®µä¾èµ–å…³ç³»è‡ªåŠ¨ç¡®å®šè®¡ç®—æ‰§è¡Œé¡ºåº

### è®¡ç®—è§„åˆ™ç®¡ç†
- ç®¡ç†å­—æ®µä¾èµ–å…³ç³»
- **ä¾èµ–å›¾æž„å»º**ï¼šæž„å»ºå­—æ®µä¾èµ–å…³ç³»å›¾ï¼Œæ£€æµ‹å¾ªçŽ¯ä¾èµ–
- **æ‹“æ‰‘æŽ’åº**ï¼šä½¿ç”¨æ‹“æ‰‘æŽ’åºç®—æ³•ç¡®å®šæœ€ä¼˜è®¡ç®—é¡ºåº

## ðŸ”„ è®¡ç®—é¡ºåºå¤„ç†æœºåˆ¶

è®¡ç®—å¼•æ“Žéœ€è¦å¤„ç†å­—æ®µé—´çš„å¤æ‚ä¾èµ–å…³ç³»ï¼Œç¡®ä¿è®¡ç®—çš„æ­£ç¡®æ€§å’Œæ•ˆçŽ‡ã€‚ç³»ç»Ÿé‡‡ç”¨å›¾è®ºä¸­çš„æ‹“æ‰‘æŽ’åºç®—æ³•æ¥è§£å†³å­—æ®µè®¡ç®—é¡ºåºé—®é¢˜ï¼Œä¸»è¦åŒ…æ‹¬ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š

### æ ¸å¿ƒæ¦‚å¿µ
- **ä¾èµ–å…³ç³»åˆ†æž**ï¼šåˆ†æžæ¯ä¸ªè®¡ç®—å­—æ®µçš„ä¾èµ–å…³ç³»ï¼Œæž„å»ºæœ‰å‘æ— çŽ¯å›¾
- **æ‹“æ‰‘æŽ’åº**ï¼šä½¿ç”¨æ‹“æ‰‘æŽ’åºç®—æ³•ç¡®å®šæœ€ä¼˜çš„è®¡ç®—æ‰§è¡Œé¡ºåº
- **å¾ªçŽ¯ä¾èµ–æ£€æµ‹**ï¼šè‡ªåŠ¨æ£€æµ‹å’ŒæŠ¥å‘Šé…ç½®é”™è¯¯å¯¼è‡´çš„å¾ªçŽ¯ä¾èµ–
- **åˆ†å±‚è®¡ç®—**ï¼šå°†å­—æ®µæŒ‰ä¾èµ–å±‚çº§åˆ†ç»„ï¼ŒåŒå±‚å­—æ®µå¯å¹¶è¡Œè®¡ç®—
- **åŠ¨æ€ä¾èµ–**ï¼šæ”¯æŒåŸºäºŽæ•°æ®å†…å®¹çš„æ¡ä»¶ä¾èµ–å…³ç³»

### åº”ç”¨åœºæ™¯
- å¤æ‚çš„è´¢åŠ¡è®¡ç®—é“¾ï¼šå•ä»·Ã—æ•°é‡â†’å°è®¡â†’æŠ˜æ‰£â†’ç¨Žè´¹â†’æ€»è®¡
- å¤šçº§æ±‡æ€»è®¡ç®—ï¼šå­è¡¨æ±‡æ€»â†’ä¸»è¡¨è®¡ç®—â†’æœ€ç»ˆç»“æžœ
- æ¡ä»¶è®¡ç®—ï¼šæ ¹æ®å®¢æˆ·ç±»åž‹ã€è®¢å•é‡‘é¢ç­‰æ¡ä»¶åŠ¨æ€è®¡ç®—

è¯¦ç»†çš„ç®—æ³•å®žçŽ°å’Œä»£ç ç¤ºä¾‹è¯·å‚è€ƒï¼š[å­—æ®µè®¡ç®—é¡ºåºç®—æ³•è¯¦è§£](3-2-calculation-order-algorithm.md)

### 1. ä¾èµ–åˆ†æž
```javascript
// åˆ†æžè®¡ç®—ä¾èµ–å…³ç³»ï¼Œç¡®å®šæ‰§è¡Œé¡ºåº
const dependencyGraph = {
  "child.subtotal": [],                    // æ— ä¾èµ–ï¼Œä¼˜å…ˆè®¡ç®—
  "main.totalAmount": ["child.subtotal"],  // ä¾èµ–å­è¡¨è®¡ç®—ç»“æžœ
  "main.finalAmount": ["main.totalAmount"] // ä¾èµ–ä¸»è¡¨å…¶ä»–å­—æ®µ
};
```

### 2. å­è¡¨è®¡ç®—
```javascript
// å¯¹æ¯ä¸ªå­è¡¨è®°å½•æ‰§è¡Œè®¡ç®—
childRecordList.forEach(record => {
  childRules.forEach(rule => {
    const inputs = extractInputs(record, rule.dependencies);
    const result = evaluateFormula(rule.formula, inputs);
    record[rule.targetField] = applyPrecision(result, rule.precision);
  });
});
```

### 3. ä¸»è¡¨è®¡ç®—
```javascript
// æ‰§è¡Œä¸»è¡¨æ±‡æ€»è®¡ç®—
mainRules.forEach(rule => {
  if (rule.aggregationType) {
    // èšåˆè®¡ç®—
    const values = extractAggregationValues(childRecordList, rule.dependencies);
    const result = performAggregation(rule.aggregationType, values);
    mainRecord[rule.targetField] = applyPrecision(result, rule.precision);
  } else {
    // æ™®é€šè®¡ç®—
    const inputs = extractInputs(mainRecord, rule.dependencies);
    const result = evaluateFormula(rule.formula, inputs);
    mainRecord[rule.targetField] = applyPrecision(result, rule.precision);
  }
});
```

## âŒ é”™è¯¯å¤„ç†

### é”™è¯¯ç±»åž‹åˆ†ç±»

| é”™è¯¯ä»£ç  | é”™è¯¯ç±»åž‹ | è¯´æ˜Ž |
|----------|----------|------|
| FORMULA_SYNTAX_ERROR | å…¬å¼è¯­æ³•é”™è¯¯ | è®¡ç®—å…¬å¼è¯­æ³•ä¸æ­£ç¡® |
| DEPENDENCY_NOT_FOUND | ä¾èµ–å­—æ®µä¸å­˜åœ¨ | è®¡ç®—ä¾èµ–çš„å­—æ®µåœ¨æ•°æ®ä¸­ä¸å­˜åœ¨ |
| DIVISION_BY_ZERO | é™¤é›¶é”™è¯¯ | è®¡ç®—è¿‡ç¨‹ä¸­å‡ºçŽ°é™¤é›¶æ“ä½œ |
| CALCULATION_OVERFLOW | è®¡ç®—æº¢å‡º | è®¡ç®—ç»“æžœè¶…å‡ºæ•°å€¼èŒƒå›´ |
| AGGREGATION_ERROR | èšåˆè®¡ç®—é”™è¯¯ | èšåˆå‡½æ•°æ‰§è¡Œå¤±è´¥ |

### é”™è¯¯æ¢å¤ç­–ç•¥
```javascript
{
  errorRecovery: {
    skipInvalidRecords: true,     // è·³è¿‡æ— æ•ˆè®°å½•
    useDefaultValues: true,       // ä½¿ç”¨é»˜è®¤å€¼
    logErrors: true,              // è®°å½•é”™è¯¯æ—¥å¿—
    continueOnError: false        // é‡åˆ°é”™è¯¯æ˜¯å¦ç»§ç»­
  }
}
```

## ðŸ”§ é…ç½®é€‰é¡¹


## ðŸ“Š æ€§èƒ½æŒ‡æ ‡

## ðŸ§ª æµ‹è¯•ç”¨ä¾‹

### æ­£å¸¸åœºæ™¯æµ‹è¯•
4. JSå…¬å¼è®¡ç®—

### å¼‚å¸¸åœºæ™¯æµ‹è¯•
1. é™¤é›¶é”™è¯¯å¤„ç†
2. ä¾èµ–å­—æ®µç¼ºå¤±
3. å…¬å¼è¯­æ³•é”™è¯¯
4. è®¡ç®—æº¢å‡ºå¤„ç†

### æ€§èƒ½æµ‹è¯•
1. å¤§æ•°æ®é‡è®¡ç®—
2. å¤æ‚å…¬å¼æ€§èƒ½
3. å¹¶è¡Œè®¡ç®—æ•ˆæžœ

## ðŸ”— ä¸Šä¸‹æ¸¸æ¨¡å—æŽ¥å£

### æŽ¥æ”¶æ¥è‡ªæ•°æ®èŽ·å–æ¨¡å—
```javascript
{
  recordData: {
    mainRecord: { /* ä¸»è¡¨è®°å½• */ },
    childRecordList: [ /* å­è¡¨è®°å½•åˆ—è¡¨ */ ]
  },
  calculationRules: { /* è®¡ç®—è§„åˆ™é…ç½® */ }
}
```

### ä¼ é€’ç»™éªŒè¯å¯¹æ¯”æ¨¡å—
```javascript
{
  calculatedResults: {
    childCalculations: [ /* å­è¡¨è®¡ç®—ç»“æžœ */ ],
    mainCalculations: { /* ä¸»è¡¨è®¡ç®—ç»“æžœ */ },
    calculationMetadata: { /* è®¡ç®—å…ƒä¿¡æ¯ */ }
  },
  originalData: { /* åŽŸå§‹æ•°æ®ï¼Œç”¨äºŽå¯¹æ¯” */ },
  validationRules: { /* éªŒè¯è§„åˆ™ */ }
}
```

## ðŸ”„ è®¡ç®—ä¼˜åŒ–ç­–ç•¥

### å¹¶è¡Œè®¡ç®—
```javascript
// å­è¡¨è®°å½•å¹¶è¡Œè®¡ç®—
const childCalculationPromises = childRecordList.map(async (record) => {
  return await calculateChildRecord(record, childRules);
});

const childResults = await Promise.all(childCalculationPromises);
```
