# 后端数据验算系统模块化架构总览

## 📝 概述

本文档是后端数据验算系统模块化架构的总览文档。系统被拆分为6个独立、可维护的模块，每个模块职责单一，通过标准化接口进行交互，确保系统的可扩展性、可测试性和可维护性。

## 🎯 业务背景

### 问题场景
- **用户行为**：用户通过飞书低代码软件向数据库提交数据
- **安全风险**：用户可能通过前端手段（如JavaScript）篡改表单数据
- **解决方案**：通过后端云函数重新验算，确保数据完整性

### 典型业务案例
- **主表**：采购单（包含采购单总价等汇总字段）
- **子表**：商品SKU明细（包含单价、数量、小计等字段）
- **验算逻辑**：单价 × 数量 = 商品小计，所有商品小计求和 = 采购单总价

## 🏗️ 模块化架构总览

系统采用分层模块化设计，共分为6个核心模块：

1. **[请求处理模块](./1-request-handler.md)** - 负责参数验证和请求路由
2. **[数据获取模块](./2-data-retriever.md)** - 负责从数据库获取完整的主子表数据
3. **[计算引擎模块](3-1-calculation-engine.md)** - 负责执行各种业务计算逻辑
4. **[验证对比模块](./4-validation-comparator.md)** - 负责对比计算值与提交值，检测篡改
5. **[纠错处理模块](./5-correction-processor.md)** - 负责自动纠正被篡改的数据
6. **[结果输出模块](../../../../../docs/guides/aa/aaas/a.md)** - 负责格式化和输出最终结果

每个模块都有明确的输入输出接口，可以独立开发、测试和维护。

## 🔄 模块间协作流程

### 整体处理流程
1. **请求接收** → 请求处理模块验证参数并路由
2. **数据准备** → 数据获取模块从数据库获取完整数据
3. **计算执行** → 计算引擎模块执行业务计算逻辑
4. **验证检测** → 验证对比模块检测数据篡改
5. **纠错处理** → 纠错处理模块自动纠正篡改数据
6. **结果输出** → 结果输出模块格式化最终结果

### 模块间数据传递
- **请求上下文**：在各模块间传递请求信息和配置
- **数据上下文**：传递主子表数据和元信息
- **计算结果对象**：传递计算结果和计算详情
- **验证结果对象**：传递验证结果和篡改详情

### 错误处理机制
每个模块都实现统一的错误处理接口：
- **错误分类**：参数错误、数据错误、计算错误、系统错误
- **错误传播**：下游模块接收上游错误并决定是否继续处理
- **错误恢复**：支持部分错误的自动恢复机制
- **错误日志**：详细记录错误发生的模块、时间和上下文

## 🎯 架构优势

### 高内聚低耦合
- 每个模块职责单一，内部逻辑高度内聚
- 模块间通过标准接口交互，降低耦合度
- 支持模块独立开发和部署

### 可扩展性强
- 新增业务逻辑只需扩展相应模块
- 支持插件化的计算规则和验证规则
- 易于适配不同的业务场景

### 可测试性好
- 每个模块可独立进行单元测试
- 标准化的输入输出便于编写测试用例
- 支持模拟依赖进行集成测试

### 可维护性高
- 模块边界清晰，便于定位和修复问题
- 代码结构清晰，降低维护成本
- 支持渐进式重构和优化

### 性能可控
- 每个模块的性能指标可独立监控
- 支持针对性的性能优化
- 便于识别系统瓶颈

## 📚 文档结构

- **[0-overview.md](0-1-overview.md)** - 本文档，系统总览
- **[1-request-handler.md](./1-request-handler.md)** - 请求处理模块详细设计
- **[2-data-retriever.md](./2-data-retriever.md)** - 数据获取模块详细设计
- **[3-calculation-engine.md](3-1-calculation-engine.md)** - 计算引擎模块详细设计
- **[4-validation-comparator.md](./4-validation-comparator.md)** - 验证对比模块详细设计
- **[5-correction-processor.md](./5-correction-processor.md)** - 纠错处理模块详细设计
- **[6-result-formatter.md](../../../../../docs/guides/aa/aaas/a.md)** - 结果输出模块详细设计

## 🚀 快速开始

1. 阅读本总览文档了解整体架构
2. 根据开发需要查看具体模块的详细设计文档
3. 参考各模块的输入输出格式示例进行开发
4. 遵循模块间的标准接口规范进行集成

每个模块文档都包含详细的职责描述、核心功能、输入输出格式示例，为开发提供完整的技术规范。