# 字段级自定义JS函数计算优先级方案详解

## 核心设计思路

为了实现每个字段都能通过自定义JS函数计算正确值，我们需要建立一个智能的优先级系统来处理字段间的依赖关系。这个系统能够自动确定计算顺序，确保每个字段的计算都在它所依赖的字段之后执行。以下是完整的自然语言描述方案：

### 一、依赖关系声明机制
每个字段的自定义函数都需要明确声明它所依赖的其他字段。例如：
- 商品总价字段（`line_total`）声明依赖单价（`unit_price`）和数量（`quantity`）
- 折扣后价格字段（`discounted_price`）声明依赖商品总价（`line_total`）和折扣率（`discount_rate`）
- 订单总价字段（`order_total`）声明依赖折扣后价格（`discounted_price`）和税费（`tax_amount`）

这种声明让系统能够理解字段间的依赖链条。

### 二、依赖关系图构建
系统会基于所有字段的依赖声明构建一个依赖关系图：
1. 每个字段作为图中的一个节点
2. 当字段A依赖字段B时，建立一条从B指向A的箭头
3. 同时记录反向依赖关系（哪些字段依赖于当前字段）

例如：
- `unit_price` → `line_total`
- `quantity` → `line_total`
- `line_total` → `discounted_price`
- `discount_rate` → `discounted_price`
- `discounted_price` → `order_total`
- `tax_rate` → `tax_amount`
- `tax_amount` → `order_total`

### 三、计算优先级确定（拓扑排序）
系统使用拓扑排序算法自动确定计算顺序：
1. 首先找出所有没有依赖的"源头字段"（如`unit_price`, `quantity`, `customer_type`等）
2. 然后处理直接依赖这些源头字段的字段（如`line_total`）
3. 接着处理依赖上一级结果的字段（如`discounted_price`）
4. 最后处理最顶层的聚合字段（如`order_total`）

具体过程：
- 系统会遍历所有字段节点
- 从没有依赖的字段开始，将其加入执行队列
- 然后"移除"这些字段对其他字段的依赖
- 重复这个过程，直到所有字段都被处理
- 最终得到一个有序的计算序列

### 四、循环依赖检测与处理
当字段间存在相互依赖时（如A依赖B，B又依赖A），系统会：
1. 在构建依赖图时检测出循环依赖
2. 立即抛出错误并明确指示哪个字段导致了循环
3. 提供解决方案：
   - 建议用户修改字段依赖关系
   - 为循环字段设置默认值（如0或null）
   - 尝试重新计算（最多3次迭代避免死循环）

### 五、计算执行流程
系统按确定好的优先级顺序执行计算：
1. 从源头字段开始（这些字段通常没有自定义函数）
2. 依次计算每个依赖字段：
   - 准备该字段所需的所有依赖字段值
   - 捕获并处理可能的错误
   - 将计算结果存储到记录中
3. 最后计算最顶层的聚合字段

2. **结果缓存**：
   - 基于依赖字段的值组合创建缓存键
   - 相同输入直接返回缓存结果
   - 显著提升重复计算的性能

### 七、错误处理机制
1. 函数执行错误时：
   - 捕获详细错误信息（行号、错误类型）
   - 保留字段原值或设为null
   - 记录错误日志便于调试

2. 依赖字段缺失时：
   - 提供默认值（0、空字符串等）
   - 标记计算结果为"部分计算"

2. **执行顺序预览**：
   - 显示系统自动确定的计算顺序

3. **循环依赖检测器**：
   - 在保存配置前自动检查

### 九、实际应用示例
假设一个订单系统有以下字段：
1. 基础字段（无依赖）：
   - `unit_price`（单价）
   - `quantity`（数量）
   - `customer_type`（客户类型）
   - `tax_rate`（税率）

2. 一级计算字段：
   - `line_total` = `unit_price` * `quantity`
   - `discount_rate` = 如果`customer_type`是VIP则15%否则0%

3. 二级计算字段：
   - `discounted_price` = `line_total` * (1 - `discount_rate`)

4. 三级计算字段：
   - `tax_amount` = `discounted_price` * `tax_rate`
   - `order_total` = `discounted_price` + `tax_amount`

**系统自动确定的计算顺序**：
1. 基础字段：`unit_price`, `quantity`, `customer_type`, `tax_rate`
2. 一级字段：`line_total`, `discount_rate`
3. 二级字段：`discounted_price`
4. 三级字段：`tax_amount`, `order_total`

### 十、最佳实践建议
1. **保持函数简洁**：单个函数最好不超过50行代码
2. **明确声明依赖**：确保所有依赖字段都被准确声明
3. **避免副作用**：函数不应修改其他字段值
4. **充分测试**：为每个自定义函数编写测试用例
5. **性能监控**：定期检查计算耗时长的字段

通过这个智能优先级系统，开发者可以专注于编写单个字段的计算逻辑，而无需手动管理复杂的依赖关系，系统会自动确保所有字段按正确顺序计算，同时提供强大的错误处理和性能优化能力。