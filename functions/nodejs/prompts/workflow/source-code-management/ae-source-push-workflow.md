# AE Source Push Workflow

## 📝 概述

`ae source push` 源代码推送的完整工作流程，包含AI助手执行推送操作时的安全确认机制和问题处理流程。本工作流程确保源代码推送的安全性和可靠性。

## ⚠️ 必读前置知识

在执行本工作流程前，请务必先完整阅读以下文档：

### 1. Index.meta.json 文件结构指南 - 配置文件规范
- **为什么必读**：理解 `index.meta.json` 文件的正确格式和字段要求，避免因配置错误导致推送失败，掌握常见配置错误的识别和修复方法
- **文档链接**：[Index.meta.json 文件结构指南](../../knowledge-base/function-management/index-meta-json-structure-guide.md)

### 2. 函数文件结构指南 - 项目结构理解
- **为什么必读**：理解项目的整体文件结构，确保推送的源代码符合项目规范
- **文档链接**：[云函数的基本组成与目录结构](../../knowledge-base/function-management/cloud-function-basic-structure-and-directory.md)

## 🎯 核心原则

### 1. 安全第一原则
源代码推送属于危险操作，可能影响生产环境，必须谨慎处理。
非常重要：如果遇到代码因为冲突导致无法推送，**必须立即停止推送操作**，协助用户解决冲突，然后重新执行推送，不可强行推送

### 2. 首次确认原则
AI助手在每次会话中第一次执行推送操作时，必须获得用户明确确认。

### 3. 自主修复原则
首次确认后，AI助手可以自主处理推送过程中的问题并重新推送。

### 4. 透明化原则
所有推送操作和问题处理过程必须向用户透明报告。

## 🔄 推送工作流程

### 第一阶段：推送前准备

#### 1.1 环境检查
- 确认当前工作目录正确
- 检查是否有未保存的文件修改
- 验证项目结构完整性

#### 1.2 代码质量检查
- 检查语法错误
- 验证配置文件格式
- 确认必要文件存在
- **重点检查 `index.meta.json` 文件**：
  - 验证 JSON 格式正确性
  - 检查 `label` 和 `description` 字段格式（参数级别使用字符串，函数级别使用对象）
  - 验证 `apiID` 格式符合规范（格式：`function_functionName`）
  - 确认参数类型定义正确（推荐使用 JSON 类型处理复杂数据）
  - 检查必填字段完整性

### 第二阶段：安全确认机制

#### 2.1 首次推送确认（必须执行）

**触发条件**：AI助手在当前会话中首次执行 `ae source push` 命令

**确认规则**：
1. **需要二次确认的情况**：
   - 用户仅引用本工作流程文档，但未明确表示推送意图
   - 用户的请求中没有明确的推送指令或意图表达
   
2. **无需二次确认的情况**：
   - 用户引用本工作流程文档的同时，明确表示要进行源码推送
   - 用户的请求中包含明确的推送指令（如"执行推送"、"进行源码推送"等）

**确认流程**（仅在需要二次确认时执行）：
1. **风险提示**：明确告知用户推送操作的风险
2. **操作说明**：说明即将执行的具体操作
3. **用户确认**：等待用户明确确认后才能执行

**确认模板**：
```
⚠️ 源代码推送确认

即将执行 ae source push 命令，这将把当前的源代码推送到远程仓库。

风险提示：
- 此操作将覆盖远程仓库的代码
- 可能影响其他开发者的工作
- 推送后的代码将影响生产环境

请确认是否继续推送？(y/n)
```

#### 2.2 后续推送处理

**适用场景**：用户在当前会话中已确认过首次推送

**处理方式**：
- 无需再次确认
- 可直接执行推送操作
- 自主处理推送过程中的问题

### 第三阶段：推送执行

#### 3.1 执行推送命令
```bash
ae source push
```

#### 3.2 监控推送过程
- 实时监控命令输出
- 识别错误信息
- 记录推送状态

#### 3.3 结果反馈
- 推送成功：报告推送结果
- 推送失败：分析错误原因，准备修复

### 第四阶段：问题处理与修复

#### 4.1 常见问题类型

**网络问题**：
- 连接超时
- 网络中断
- 服务器不可达

**权限问题**：
- 认证失败
- 推送权限不足
- 分支保护规则

**代码冲突**：
- 合并冲突
- 版本冲突
- 文件锁定

**配置问题**：
- 仓库配置错误
- 分支配置问题
- 远程地址错误

**函数配置错误**：
- `index.meta.json` 格式错误
- 参数类型定义错误
- 必填字段缺失
- 对象引用不存在

#### 4.2 自主修复流程

**修复原则**：
1. **优先查找错误库**：在 `../error-solutions/` 目录中查找对应的错误解决方案
2. 分析错误信息，确定问题类型
3. 应用对应的修复策略
4. 自动重新执行推送
5. 向用户报告修复过程

**错误解决方案查找顺序**：
1. **错误库优先**：首先在 `../error-solutions/` 对应分类目录下查找解决方案
2. **知识库补充**：如错误库中无解决方案，查看 `../knowledge-base/` 相关指导文档
3. **创建新方案**：如果现有文档都无法解决问题，创建新的错误解决方案文档

**修复策略**：

**网络问题修复**：
```bash
# 重试推送
ae source push
```

**权限问题修复**：
```bash
# 检查认证状态
ae auth status
# 重新认证（如需要）
ae auth login
```

**代码冲突修复**：
```bash
# 拉取最新代码
ae source pull
# 解决冲突后重新推送
ae source push
```

**配置问题修复**：
```bash
# 检查配置
ae config list
# 修复配置后重新推送
ae source push
```

**函数配置错误修复**：
```bash
# 1. 检查 index.meta.json 格式错误
# 常见错误：label 字段使用对象格式而非字符串格式
# 错误示例：
# "label": {"zh_CN": "中文名称", "en_US": "English Name"}
# 正确格式：
# "label": "中文名称"

# 2. 检查 apiID 格式错误
# 错误示例：package_facdb4__c__function_functionName
# 正确格式：function_functionName

# 3. 检查参数类型定义错误
# 对于复杂数据结构，推荐使用 JSON 类型而非 Record/RecordList
# 避免引用不存在的对象导致部署失败

# 4. 检查必填字段
# 确保所有必填字段（apiID、apiName、label、description等）都已正确填写

# 修复后重新推送
ae source push
```

#### 4.3 修复失败处理

**升级处理**：
- 如果自动修复失败，向用户报告具体问题
- 提供手动解决方案建议
- 等待用户处理后再次尝试

## 📋 操作检查清单

### 推送前检查
- [ ] 工作目录正确
- [ ] 代码修改已保存
- [ ] 配置文件格式正确
- [ ] 必要文件完整
- [ ] `index.meta.json` 格式验证通过
- [ ] 参数类型定义正确
- [ ] `apiID` 格式符合规范
- [ ] 必填字段完整

### 安全确认检查
- [ ] 首次推送已获得用户确认
- [ ] 风险提示已明确传达
- [ ] 用户理解操作后果

### 推送执行检查
- [ ] 推送命令执行成功
- [ ] 推送过程无错误
- [ ] 远程仓库更新正确

### 问题处理检查
- [ ] 错误信息已正确识别
- [ ] 修复策略已正确应用
- [ ] 修复结果已验证
- [ ] 用户已获得反馈
- [ ] 配置文件错误已修复
- [ ] 函数元数据格式已校正

## 🚨 安全注意事项

### 推送前必须确认
1. **代码质量**：确保推送的代码经过测试
2. **影响范围**：评估推送对其他开发者的影响
3. **回滚准备**：确保有回滚方案

### 推送过程监控
1. **实时监控**：密切关注推送过程
2. **错误处理**：及时发现和处理错误
3. **状态报告**：向用户及时反馈状态

### 推送后验证
1. **推送结果**：验证远程仓库更新正确
2. **功能验证**：确认推送后功能正常
3. **团队通知**：必要时通知团队成员

## 💡 最佳实践

### AI助手操作规范
1. **谨慎执行**：始终将安全放在第一位
2. **透明沟通**：所有操作向用户透明
3. **主动修复**：积极处理推送过程中的问题
4. **详细记录**：记录所有操作和问题处理过程

### 用户协作建议
1. **明确确认**：首次推送时明确表达确认意图
2. **及时反馈**：遇到问题时及时提供反馈
3. **配合处理**：配合AI助手处理复杂问题

## 📚 相关参考文档

- [错误解决方案库](../../error-solutions/README.md) - 各类错误的解决方案集合，优先查找
- [Index.meta.json 文件结构指南](../../knowledge-base/function-management/index-meta-json-structure-guide.md) - 配置文件格式和常见错误解决方案
- [Function Testing Workflow](../function-testing/function-testing-workflow.md) - 推送前的测试流程
- [Cloud Function Creation Workflow](../function-development/cloud-function-creation-workflow.md) - 云函数创建后的推送流程

## 💡 总结

`ae source push` 工作流程的核心是平衡安全性和效率：

1. **安全第一**：通过首次确认机制确保用户知情
2. **效率优化**：确认后允许AI自主处理问题
3. **透明操作**：所有操作向用户透明报告
4. **主动修复**：积极处理推送过程中的各种问题

遵循本工作流程，可以确保源代码推送的安全性和可靠性，同时提高开发效率。